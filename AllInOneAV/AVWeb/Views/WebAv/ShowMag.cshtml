@using Model.ScanModels
@using Model.Common

@{
    Dictionary<string, List<RemoteScanMag>> data = (Dictionary<string, List<RemoteScanMag>>)ViewData["data"];
}

<!DOCTYPE html>

<html>
    <head>
        <meta name="viewport" content="width=device-width" />
        <title>ShowMag</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.10.0/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        <script src="~/Scripts/waterfall.js"></script>
    </head>

    <body>
        <div class="jumbotron">
            <h1 class="display-4">种子下载</h1>
            <p class="lead">最近一次种子扫描的结果，共 @data.Count 部</p>
        </div>

        <div class="container-fluid">
            @while (data.Count > 0)
            {
                var take4 = data.Take(4);
                data = data.Skip(4).ToDictionary(x => x.Key, x => x.Value);

                <div class="row">
                    @foreach (var d in take4)
                    {

                        var classStr = "card";
                        if (d.Value.FirstOrDefault().SearchStatus == 1)
                        {
                            classStr += " bg-primary";
                        }

                        if (d.Value.FirstOrDefault().SearchStatus == 2)
                        {
                            classStr += " bg-success";
                        }

                        <div class="col">
                            <div class='@classStr'>
                                <img src="@d.Value.FirstOrDefault().AvUrl.Replace("ps.jpg", "pl.jpg")" class="card-img-top" alt="">
                                <div class="card-body">
                                    <h5 class="card-title">@d.Value.FirstOrDefault().AvId</h5>
                                    <p class="card-text">@d.Value.FirstOrDefault().AvName</p>
                                </div>
                                <ul class="list-group list-group-flush">
                                    @foreach (var dd in d.Value)
                                    {
                                        <li class="list-group-item" data-mag="@dd.MagUrl">@(dd.MagTitle + " " + Utils.FileSize.GetAutoSizeString(dd.MagSize, 1))</li>
                                    }
                                </ul>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="float-button">
            <button type="button" class="btn btn-success" id="download">下载</button>
        </div>
    </body>
</html>

<script>
    var download = '';

    $(document).ready(function () {
        $('#waterfall-container').waterfall();
    }); 

    $(".list-group-item").click(function () {
        $(this).toggleClass("list-group-item-info");
    });

    $("#download").click(function () {
        $(".list-group-item-info").each(function (index, element) {
            download += $(this).data("mag") + "\n\r";
        });

        $.ajax({
            type: 'post',
            url: '/webav/Add115Task',
            data: { 'mag': download },
            success: function(result){
                alert(result.msg);
            },
            dataType: 'json'
        });
    });
</script>